<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="/Shopping-List/manifest.json" />
  <link rel="icon" href="/Shopping-List/icon-192.png" />
  <meta name="theme-color" content="#4CAF50" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/Shopping-List/icon-192.png" />
  <title>Shopping List (Cloud Sync)</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    h1 {
      text-align: center;
    }
    input, button {
      padding: 10px;
      font-size: 1em;
      margin: 5px 0;
    }
    #itemInput {
      width: 70%;
    }
    #addBtn {
      width: 28%;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: white;
      padding: 10px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .removeBtn {
      background: red;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
    }
    hr {
      margin: 20px 0;
    }
    .control-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    #installBtn {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px;
      font-size: 1em;
      margin-top: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Shopping List By Addie</h1>

  <input id="itemInput" placeholder="Add item..." />
  <button id="addBtn">Add</button>

  <ul id="list"></ul>

  <hr />

  <div class="control-buttons">
    <button onclick="exportList()">Export List</button>
    <input type="file" accept=".json" onchange="importList(event)" />
    <button onclick="clearList()">Clear All</button>
  </div>

  <!-- Install Button -->
  <button id="installBtn">Install App</button>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    console.log("Script loaded and DOM fully parsed.");

    const apiUrl = 'https://shoppinglistaddie.glitch.me';
    const input = document.getElementById('itemInput');
    const addBtn = document.getElementById('addBtn');
    const listEl = document.getElementById('list');

    if (!addBtn) {
      console.error("Add button not found in the DOM.");
      return;
    }

    console.log("Add button successfully found:", addBtn);

    // Function to add item (online or offline)
    addBtn.addEventListener("click", async () => {
      console.log("Add button clicked.");

      const text = input.value.trim();
      if (!text) {
        console.warn("Input is empty. No item to add.");
        return; // Exit if input is empty
      }

      console.log("Adding item:", text);

      if (navigator.onLine) {
        console.log("You are online. Attempting to add item to the server...");
        try {
          const res = await fetch(`${apiUrl}/list`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });

          if (!res.ok) {
            console.error("Failed to add item online. Server responded with error.");
            throw new Error("Error adding item online.");
          }

          console.log("Item added successfully online:", text);
          addItemToDOM(text, listEl.children.length); // Display the item in the list
        } catch (error) {
          console.error("Error adding item online:", error);
          alert('Error adding item online. Please try again.');
        }
      } else {
        console.log("You are offline. Adding item to local storage...");
        try {
          // Save the item in offline storage
          const offlineItems = JSON.parse(localStorage.getItem('offlineItems')) || [];
          offlineItems.push(text);
          localStorage.setItem('offlineItems', JSON.stringify(offlineItems));
          console.log("Item saved offline:", text, "Updated offlineItems:", offlineItems);

          // Append the item to the DOM immediately
          addItemToDOM(text, listEl.children.length);
          console.log("Item added to DOM in offline mode.");
        } catch (error) {
          console.error("Error adding item offline:", error);
        }
      }

      input.value = ''; // Clear the input field
    });

    // Function to add item to the DOM
    function addItemToDOM(text, index) {
      console.log("Adding item to DOM. Text:", text, "Index:", index);

      const li = document.createElement('li');
      li.innerHTML = `<span>${text}</span>
        <button class="removeBtn" onclick="removeItem(${index})">Remove</button>`;
      listEl.appendChild(li);
    }

    // Function to remove an item
    async function removeItem(index) {
      console.log("Removing item at index:", index);

      const cachedItems = JSON.parse(localStorage.getItem('cachedList')) || [];
      const offlineItems = JSON.parse(localStorage.getItem('offlineItems')) || [];

      if (navigator.onLine) {
        console.log("You are online. Attempting to remove item from server...");
        try {
          await fetch(`${apiUrl}/list/${index}`, { method: 'DELETE' });
          loadList(); // Reload the list
        } catch (error) {
          console.error("Error removing item online:", error);
          alert('Error: Could not sync with server.');
        }
      } else {
        console.log("You are offline. Removing item locally...");
        if (index < cachedItems.length) {
          cachedItems.splice(index, 1);
          localStorage.setItem('cachedList', JSON.stringify(cachedItems));
        } else {
          offlineItems.splice(index - cachedItems.length, 1);
          localStorage.setItem('offlineItems', JSON.stringify(offlineItems));
        }

        renderList([...cachedItems, ...offlineItems]); // Re-render the updated list
      }
    }

    // Function to render the full list
    function renderList(items) {
      console.log("Rendering list. Items:", items);

      listEl.innerHTML = '';
      items.forEach((item, index) => addItemToDOM(item, index));
    }

    // Function to load the list from localStorage or API
    async function loadList() {
      console.log("Loading list...");

      const offlineItems = JSON.parse(localStorage.getItem('offlineItems')) || [];
      const cachedItems = JSON.parse(localStorage.getItem('cachedList')) || [];

      if (navigator.onLine) {
        console.log("You are online. Fetching list from the server...");
        try {
          const res = await fetch(`${apiUrl}/list`);
          const onlineItems = await res.json();
          localStorage.setItem('cachedList', JSON.stringify(onlineItems)); // Cache the list
          renderList([...onlineItems, ...offlineItems]); // Combine online and offline items
        } catch (error) {
          console.error("Error fetching list from server:", error);
          renderList([...cachedItems, ...offlineItems]); // Use cached and offline items
        }
      } else {
        console.log("You are offline. Using cached and offline items.");
        renderList([...cachedItems, ...offlineItems]); // Use cached and offline items
      }
    }

    // Initial load of the list
    loadList();
  });
</script>
</body>
</html>
